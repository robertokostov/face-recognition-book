
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Теоретски чекори &#8212; Детекција на лица и замена на лице​</title>
    
  <link href="_static/css/theme.css" rel="stylesheet" />
  <link href="_static/css/index.c5995385ac14fb8791e8eb36b4908be2.css" rel="stylesheet" />

    
  <link rel="stylesheet"
    href="_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/sphinx-book-theme.acff12b8f9c144ce68a297486a2fa670.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="_static/js/index.1c5a1a01449ed65a7b51.js">

    <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/togglebutton.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <script async="async" src="https://unpkg.com/thebelab@latest/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <link rel="shortcut icon" href="_static/favicon.ico"/>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Програма" href="notebooks.html" />
    <link rel="prev" title="Како?" href="how.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="index.html">
      
      <img src="_static/logo.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">Детекција на лица и замена на лице​</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="intro.html">
   Зошто?
  </a>
 </li>
</ul>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="how.html">
   Како?
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Теоретски чекори
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="notebooks.html">
   Програма
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="steps.html">
   Чекори при извршување на програмата
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="usage.html">
   Deepfakes
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="lib.html">
   Референци
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="_sources/theory.md"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.md</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/robertokostov/face-recognition-book"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/robertokostov/face-recognition-book/issues/new?title=Issue%20on%20page%20%2Ftheory.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#id2">
   Се избираат две слики - изворна и дестинациска​
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#dlib-landmark">
   Се користи dlib landmark детектор на двете слики​
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#id3">
   Се спојуваат точките од детекторот за да се формираат триаголници​
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#id4">
   Се прави екстракција на триаголниците​
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#id5">
   Се поставува изворната слика на дестинациската​
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#id6">
   Се измазнува лицето за поверодостоен изглед​
  </a>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="section" id="id1">
<h1>Теоретски чекори<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h1>
<div class="section" id="id2">
<h2>Се избираат две слики - изворна и дестинациска​<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<p>Најпрво треба да се изберат изворна слика(онаа чие што лице ќе биде исечено и вметнато) и дестинациска слика(онаа во која ќе биде вметнато лице). За да си го олесниме целиот процес најдобро е да избереме слики на кои што лицата се под сличен агол. Би било добро доколку сликите имаат слична боја и големина. Сето ова гарантира резултат на кој промената е непрепознатлива(секако доколку се извршат наредните чекори правилно).</p>
</div>
<div class="section" id="dlib-landmark">
<h2>Се користи dlib landmark детектор на двете слики​<a class="headerlink" href="#dlib-landmark" title="Permalink to this headline">¶</a></h2>
<p>dlib претставува библиотека во Python која ќе ја искористиме за детекција на карактеристики на лице. Под ова подразбираме очи, веѓи, нос, уста и брада. Детектирањето на овие карактеристики претставува подмножество на проблемот наречен shape prediction. Овој проблем има за цел да прими влезна слика и да ја анализира за на крај да извлече клучни точки од посакуваната форма кои ни се од интерес. Детекцијата на карактеристики се состои од два дела: детекција на лице во самата влезна слика и детекција на клучната структура на лицето. Првиот чекор може да се постигне на многу начини. Можеме да ги искористиме вградените Haar каскади во OpenCV, однапред тренирани детектори или пак алгоритми базирани на длабоко учење. Кој начин и да го избереме потполно е сеедно. Она што е важно е да правилно да ги поставиме координатите x и y на лицето на сликата. Вториот чекор се постигнува преку голем број детектори чии методи главно се сведуваат на детекција на: усни, десна веѓа, лева веѓа, десно око, лево око, нос и брада. Детекторот кој е вграден во dlib библиотеката е имплементација од One Millisecond Face Alignment with an Ensemble of Regression Trees од Kazemi and Sullivan(2014). Овој метод започнува со истрениран сет од карактеристики на лице на слика. Овој сет и рачно правен со специфицирани координати x и y кои ја опкружуваат секоја од карактеристиките кои ги споменавме. Потоа се употребуваат приори односно веројатност на далечина помеѓу парови од влезни пиксели. Со помош на овие податоци, множество регресиски дрва се тренираат да ги проценат клучните точки и нивните позиции. Крајниот резултат е детектор на карактеристики на лице во real-time со висок квалитет на предикции и токму тоа се користи во денешните апликации.</p>
<p>Детекторот во dlib се состои од 68 (x,y) координати кои ги мапираат структурите на лицето. Овие анотации се дел од iBUG 300-W dataset-oт кој го користи оваа библиотека. Овој детектор враќа shape објект кој ги содржи 68-те координати од регионите. Детекторот во dlib се состои од 68 (x,y) координати кои ги мапираат структурите на лицето. Овие анотации се дел од iBUG 300-W dataset-oт кој го користи оваа библиотека. Овој детектор враќа shape објект кој ги содржи 68-те координати од регионите.</p>
</div>
<div class="section" id="id3">
<h2>Се спојуваат точките од детекторот за да се формираат триаголници​<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h2>
<p>Овој процес уште се нарекува и delaunay triangulation. Лицето се дели на посебни сегменти. Овој чекор е јадрото на целиот процес на замена на лице, бидејќи триаголниците од изворната слика подоцна ќе бидат заменети со соодветните триаголници од дестинациската слика. Зошто го делиме лицето на триаголници? Лицата на двете слики е многу веројатно дека имаат различна големина и перспектива. Доколку ги смениме овие две работи би ја изгубиле оригиналната пропорција. Наместо тоа го делиме лицето на помали триаголници со што ќе ја задржиме оригиналната пропорција но истовремено ќе имаме совпаѓање со карактеристиките на дестинациската слика(пример насмевката, затворени очи, отворени усни). За овој чекор да биде успешен потребно е да се искористи истата шема и на изворната и на дестинациската слика. Со други зборови, поврзувањето на точките треба да биде исто. Ова може да се постигне со numpy и функциите np.where() и np.extract_index_nparray() или пак со getTriangleList() од OpenCV. На крај од добиените индекси со np.array() се формираат триаголници.</p>
</div>
<div class="section" id="id4">
<h2>Се прави екстракција на триаголниците​<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h2>
<p>Ова е уште наречено face warping. Откако ја имаме триангулацијата на двете лица, најпрво ја земаме онаа од изворната слика и со помош на функции како np.float32(), np.getAffineTransform(), np.warpAffine() правиме екстракција на триаголниците. Притоа се земаат координатите на дестинациската слика со цел да се обрати внимание на големината и перпективата и да се обезбеди потполно усогласување на триаголниците. Во идеални услови ова би се одвивало на 3D информации меѓутоа најчесто нив ги немаме па 2D ги трансформираме во апроксимации на 3D информации на лице. Процесот на warping се постигнува преку Барицентрични координати претставени со [αi, βi, γi]^T каде што i ∈ [1,2,3..] - број на пиксел. Овие координати се пресметани за секој пиксел на сликата со помош на следната формула:</p>
<p><img alt="formula" src="_images/formule.png" /></p>
</div>
<div class="section" id="id5">
<h2>Се поставува изворната слика на дестинациската​<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h2>
<p>Oткако ги имаме триаголниците исечени следно што треба да се направи е да се спојат заедно. Едноставно се прави реконструкција на лицата со помош на триангуларната шема, но овој пат се употребуваат триаголниците на кои им била извршена екстракција(warping). Oваа операција може да се изврши со помош на функции како np.zeros() и cv2.add(). На крајот од оваа операција имаме лице од изворната слика кое е спремно за замена. Се сече лицето од дестинациската слика за да се направи место за новото и со помош на cv2.fillConvexPoly() и cv2.add() го додаваме новото лице.</p>
</div>
<div class="section" id="id6">
<h2>Се измазнува лицето за поверодостоен изглед​<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h2>
<p>По завршувањето на чекор 5 промената на лицата е сосема видлива. Ова е заради различната текстура и истакнатите рабови. За да ја направиме транзицијата скоро па и невидлива мора да се погрижиме боите, текстурата и рабовите да одговараат на дестинациската слика. Ова лесно се постигнува со функцијата cv2.seamlessClone().</p>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        
        <div class='prev-next-bottom'>
            
    <a class='left-prev' id="prev-link" href="how.html" title="previous page">Како?</a>
    <a class='right-next' id="next-link" href="notebooks.html" title="next page">Програма</a>

        </div>
        
        </div>
    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          By Teona Kostova, Roberto Kostov<br/>
        
            &copy; Copyright 2021.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
  
  <script src="_static/js/index.1c5a1a01449ed65a7b51.js"></script>

  
  </body>
</html>