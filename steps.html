
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Чекори при извршување на програмата &#8212; Детекција на лица и замена на лице​</title>
    
  <link href="_static/css/theme.css" rel="stylesheet" />
  <link href="_static/css/index.c5995385ac14fb8791e8eb36b4908be2.css" rel="stylesheet" />

    
  <link rel="stylesheet"
    href="_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/sphinx-book-theme.acff12b8f9c144ce68a297486a2fa670.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="_static/js/index.1c5a1a01449ed65a7b51.js">

    <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/togglebutton.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <script async="async" src="https://unpkg.com/thebelab@latest/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <link rel="shortcut icon" href="_static/favicon.ico"/>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Deepfakes" href="usage.html" />
    <link rel="prev" title="Програма" href="notebooks.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="index.html">
      
      <img src="_static/logo.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">Детекција на лица и замена на лице​</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="intro.html">
   Зошто?
  </a>
 </li>
</ul>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="how.html">
   Како?
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="notebooks.html">
   Програма
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Чекори при извршување на програмата
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="usage.html">
   Deepfakes
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="lib.html">
   Референци
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="_sources/steps.md"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.md</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/robertokostov/face-recognition-book"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/robertokostov/face-recognition-book/issues/new?title=Issue%20on%20page%20%2Fsteps.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#id2">
   Вчитување на потребните пакети и слики кои ни се потребни
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#landmark">
   Дефинирање на потребните детектор на лица и предвидувач на “landmark” точки на истите и нивно искористување
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#delaunay">
   Примена на методата на триангулација на Delaunay и наоѓање на триаголници на лицата соодветно
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#id3">
   Трансформација на содржината на секој триаголник од првата слика во соодветниот триаголник од втората
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#id4">
   Подобрувања на решението
  </a>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="section" id="id1">
<h1>Чекори при извршување на програмата<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h1>
<div class="section" id="id2">
<h2>Вчитување на потребните пакети и слики кои ни се потребни<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<ul>
<li><p>Импорт на сите потребни пакети:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">cv2</span>
<span class="kn">import</span> <span class="nn">dlib</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</pre></div>
</div>
</li>
<li><p>Вчитување на двете слики, изворната и крајната, врз која ќе се врши замената на лицата и нивно претворање во сив формат:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">img1</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="s2">&quot;media/736px-Josip_Broz_Tito_uniform_portrait.jpg&quot;</span><span class="p">)</span>
<span class="n">img2</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="s2">&quot;media/768px-Queen_Elizabeth_II_of_New_Zealand_(cropped).jpg&quot;</span><span class="p">)</span>

<span class="n">img1_gray</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">img1</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2GRAY</span><span class="p">)</span>
<span class="n">img2_gray</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">img2</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2GRAY</span><span class="p">)</span>
</pre></div>
</div>
</li>
</ul>
</div>
<div class="section" id="landmark">
<h2>Дефинирање на потребните детектор на лица и предвидувач на “landmark” точки на истите и нивно искористување<a class="headerlink" href="#landmark" title="Permalink to this headline">¶</a></h2>
<ul>
<li><p>Дефинирање на детекторот и предвидувачот користени за наоѓање на лица на дадена слика и модел за предвидување на 68 “landmark” точки на истите:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">detector</span> <span class="o">=</span> <span class="n">dlib</span><span class="o">.</span><span class="n">get_frontal_face_detector</span><span class="p">()</span>
<span class="n">predictor</span> <span class="o">=</span> <span class="n">dlib</span><span class="o">.</span><span class="n">shape_predictor</span><span class="p">(</span><span class="s2">&quot;media/shape_predictor_68_face_landmarks.dat&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p><img alt="landmark" src="_images/landmark.jpg" /></p>
</li>
<li><p>Примена на истото кон изворната слика:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">faces</span> <span class="o">=</span> <span class="n">detector</span><span class="p">(</span><span class="n">img1_gray</span><span class="p">)</span>
<span class="k">for</span> <span class="n">face</span> <span class="ow">in</span> <span class="n">faces</span><span class="p">:</span>
    <span class="n">landmarks</span> <span class="o">=</span> <span class="n">predictor</span><span class="p">(</span><span class="n">img1_gray</span><span class="p">,</span> <span class="n">face</span><span class="p">)</span>
    <span class="n">landmarks_points1</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">68</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">landmarks</span><span class="o">.</span><span class="n">part</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="o">.</span><span class="n">x</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">landmarks</span><span class="o">.</span><span class="n">part</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="o">.</span><span class="n">y</span>
        <span class="n">landmarks_points1</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>
</pre></div>
</div>
<p><img alt="landmark-example" src="_images/landmark_example.jpg" /></p>
</li>
<li><p>Земање на надворешните “landmark” точки од сликата како релевантни за изборот на лицето:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>    <span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">landmarks_points1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="n">convexhull</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">convexHull</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>
</pre></div>
</div>
<p><img alt="convexhull_example" src="_images/convexhull_example.jpg" /></p>
</li>
<li><p>Со помош на надворешните “landmark” точки кои ги детектиравме креираме маска со чија помош го земаме делот што е внатре во полигонот дефиниран од истите точки како валиден:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">img1_gray</span><span class="p">)</span>
<span class="o">...</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">fillConvexPoly</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">convexhull</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>
</pre></div>
</div>
<p><img alt="mask_example" src="_images/mask_example.jpg" /></p>
</li>
</ul>
</div>
<div class="section" id="delaunay">
<h2>Примена на методата на триангулација на Delaunay и наоѓање на триаголници на лицата соодветно<a class="headerlink" href="#delaunay" title="Permalink to this headline">¶</a></h2>
<ul>
<li><p>Доколку го искористиме целото лице за директна замена, остануваме склони дека при некое движење на истото, насмевка или нешто друго, ќе се добие замена со послаб квалитет. Затоа, замената ќе ја донесеме на ниво на “landmark” точките и методата на триангулација на “Delaunay”. Помеѓу секои три најблиски од нив ќе нацртаме триаголници и замената ќе ја правиме помеѓу нив соодветно. Па така, доколку лицето за замена малку се помрдне, или се насмее, делот од сликата кој ќе биде афектиран од тоа ќе е значително помал:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>    <span class="n">rect</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">boundingRect</span><span class="p">(</span><span class="n">convexhull</span><span class="p">)</span>
    <span class="n">subdiv</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">Subdiv2D</span><span class="p">(</span><span class="n">rect</span><span class="p">)</span>
    <span class="n">subdiv</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">landmarks_points1</span><span class="p">)</span>
    <span class="n">triangles</span> <span class="o">=</span> <span class="n">subdiv</span><span class="o">.</span><span class="n">getTriangleList</span><span class="p">()</span>
    <span class="n">triangles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">triangles</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>

    <span class="n">indexes_triangles</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">triangles</span><span class="p">:</span>
        <span class="n">pt1</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">pt2</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">t</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">pt3</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">t</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>

        <span class="n">index_pt1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">points</span> <span class="o">==</span> <span class="n">pt1</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">index_pt1</span> <span class="o">=</span> <span class="n">extract_index_nparray</span><span class="p">(</span><span class="n">index_pt1</span><span class="p">)</span>

        <span class="n">index_pt2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">points</span> <span class="o">==</span> <span class="n">pt2</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">index_pt2</span> <span class="o">=</span> <span class="n">extract_index_nparray</span><span class="p">(</span><span class="n">index_pt2</span><span class="p">)</span>

        <span class="n">index_pt3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">points</span> <span class="o">==</span> <span class="n">pt3</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">index_pt3</span> <span class="o">=</span> <span class="n">extract_index_nparray</span><span class="p">(</span><span class="n">index_pt3</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">index_pt1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">index_pt2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">index_pt3</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">triangle</span> <span class="o">=</span> <span class="p">[</span><span class="n">index_pt1</span><span class="p">,</span> <span class="n">index_pt2</span><span class="p">,</span> <span class="n">index_pt3</span><span class="p">]</span>
            <span class="n">indexes_triangles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">triangle</span><span class="p">)</span>
</pre></div>
</div>
<p><img alt="delaunay_example" src="_images/delaunay_example.jpg" /></p>
<p>Некои од вредностите во <strong>indexes_triangles</strong> се следните:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">[[</span><span class="mi">36</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">37</span><span class="p">],</span> <span class="p">[</span><span class="mi">18</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mi">17</span><span class="p">],</span> <span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">57</span><span class="p">,</span> <span class="mi">8</span><span class="p">],</span> <span class="o">...</span><span class="p">]</span>
</pre></div>
</div>
<p>Ова значи дека ќе имаме триаголници помеѓу точките <strong>36, 18, 37</strong>, потоа <strong>18, 36, 17</strong> и тн. од сликата:</p>
<p><img alt="landmark2" src="_images/landmark2.png" /></p>
</li>
<li><p>Истите триаголниците кои ги најдовме кај изворната слика ги применуваме и кај дестинациската:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">triangle_index</span> <span class="ow">in</span> <span class="n">indexes_triangles</span><span class="p">:</span>
    <span class="n">pt1_2</span> <span class="o">=</span> <span class="n">landmarks_points2</span><span class="p">[</span><span class="n">triangle_index</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
    <span class="n">pt2_2</span> <span class="o">=</span> <span class="n">landmarks_points2</span><span class="p">[</span><span class="n">triangle_index</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
    <span class="n">pt3_2</span> <span class="o">=</span> <span class="n">landmarks_points2</span><span class="p">[</span><span class="n">triangle_index</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>
</pre></div>
</div>
<p><img alt="triangulation_example" src="_images/triangulation_example.jpg" /></p>
</li>
<li><p>За секоја од двете слики извршуваме операциите над секој од соодветните триаголници:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>    <span class="n">tr1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">pt1_1</span><span class="p">,</span> <span class="n">pt2_1</span><span class="p">,</span> <span class="n">pt3_1</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="n">rect1</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">boundingRect</span><span class="p">(</span><span class="n">tr1</span><span class="p">)</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">rect1</span>
    <span class="n">cropped_triangle1</span> <span class="o">=</span> <span class="n">img1</span><span class="p">[</span><span class="n">y</span><span class="p">:</span> <span class="n">y</span> <span class="o">+</span> <span class="n">h</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">+</span> <span class="n">w</span><span class="p">]</span>
    <span class="n">cropped_tr1_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>

    <span class="n">points1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">pt1_1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">,</span> <span class="n">pt1_1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">y</span><span class="p">],</span> <span class="p">[</span><span class="n">pt2_1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">,</span> <span class="n">pt2_1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">y</span><span class="p">],</span> <span class="p">[</span><span class="n">pt3_1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">,</span> <span class="n">pt3_1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">y</span><span class="p">]],</span>
                       <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">fillConvexPoly</span><span class="p">(</span><span class="n">cropped_tr1_mask</span><span class="p">,</span> <span class="n">points1</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>
    <span class="n">cropped_triangle1</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">bitwise_and</span><span class="p">(</span><span class="n">cropped_triangle1</span><span class="p">,</span> <span class="n">cropped_triangle1</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">cropped_tr1_mask</span><span class="p">)</span>
</pre></div>
</div>
<p>Со помош на трите точки од триаголникот, дефинираме правоаголник над него со соодветни x и y координати на една точка, должина и ширина како вредности. Тој правоаголник го опфаќа делот од внатре од триаголникот, но и тој надвор од него. За да се отстрани тој креираме маска со должина и ширина иста како неговата. Со помош на <strong>fillConvexPoly</strong> функцијата делот од маската кој е опфатен од триаголникот ќе го обоиме бел(вредноста 255), делот кој не е ќе си остане како што беше и кога го креиравме, црн. Кога маската ќе ја примениме на делот земен од изворната слика со помош на <strong>bitwise_and</strong> операцијата, го добиваме само делот од триаголникот кој ни треба, бидејќи црно(0) <strong>bitwise_and</strong> вредноста од сликата прави тој дел од сликата да стане црн, а со обоениот дел од маската сликата ќе си ја задржи бојата.</p>
</li>
</ul>
</div>
<div class="section" id="id3">
<h2>Трансформација на содржината на секој триаголник од првата слика во соодветниот триаголник од втората<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h2>
<ul>
<li><p>Откако ги добиеме “чисти” секој од соодветните триаголници кои ќе ги смениме, применуваме дополнителни трансформации:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>    <span class="n">points1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">points1</span><span class="p">)</span>
    <span class="n">points2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">points2</span><span class="p">)</span>

    <span class="n">M</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">getAffineTransform</span><span class="p">(</span><span class="n">points1</span><span class="p">,</span> <span class="n">points2</span><span class="p">)</span>

    <span class="n">warped_triangle</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">warpAffine</span><span class="p">(</span><span class="n">cropped_triangle1</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">))</span>
    <span class="n">warped_triangle</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">bitwise_and</span><span class="p">(</span><span class="n">warped_triangle</span><span class="p">,</span> <span class="n">warped_triangle</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">cropped_tr2_mask</span><span class="p">)</span>
</pre></div>
</div>
<p>Со помош на матрични трансформации, точките од првиот триаголник(делчето од сликата кое што сакаме да го пренесеме на новата слика) ги претвораме во точки од вториот триаголник(делчето од новата слика врз кое што пренесуваме). Потоа и самиот триаголник од првата слика, заедно со содржината негова, го трансформираме во новите вредности на точките, како и должината и ширината од триаголникот на втората слика. Со цел подобар квалитет при примена применуваме повторно <strong>bitwise_and</strong> операција со помош на маската на триаголникот од втората слика. Со помош на овие операции стигнавме до тука:</p>
<p><img alt="new_face_with_problems" src="_images/new_face_with_problems.jpg" /></p>
<p>Забележуваме прогрес, но и проблем. Прогресот е дека користејќи ја следната линија код:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>    <span class="n">img2_new_face</span><span class="p">[</span><span class="n">y</span><span class="p">:</span> <span class="n">y</span> <span class="o">+</span> <span class="n">h</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">+</span> <span class="n">w</span><span class="p">]</span> <span class="o">=</span> <span class="n">warped_triangle</span>
</pre></div>
</div>
<p>Си го пребришуваме прогресот. Еден триаголник ќе се запише добро, соседниот има црни делови поради маската околу него, па ќе го пребрише. Решението го пронајдовме со користење на вградената функција <strong>add</strong>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>    <span class="n">img2_new_face_rect_area</span> <span class="o">=</span> <span class="n">img2_new_face</span><span class="p">[</span><span class="n">y</span><span class="p">:</span> <span class="n">y</span> <span class="o">+</span> <span class="n">h</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">+</span> <span class="n">w</span><span class="p">]</span>

    <span class="n">img2_new_face_rect_area</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">img2_new_face_rect_area</span><span class="p">,</span> <span class="n">warped_triangle</span><span class="p">)</span>
    <span class="n">img2_new_face</span><span class="p">[</span><span class="n">y</span><span class="p">:</span> <span class="n">y</span> <span class="o">+</span> <span class="n">h</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">+</span> <span class="n">w</span><span class="p">]</span> <span class="o">=</span> <span class="n">img2_new_face_rect_area</span>
</pre></div>
</div>
<p>На овој начин делот врз кој се запишува, најпрвин се зачувува. Потоа, преку функцијата за додавање се спречува презапишување врз веќе ставените вредности(додавање на 0 значи останување на моменталната вредност):</p>
<p><img alt="new_face_with_partial_solution" src="_images/new_face_with_partial_solution.jpg" /></p>
</li>
</ul>
</div>
<div class="section" id="id4">
<h2>Подобрувања на решението<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h2>
<ul>
<li><p>Со тоа ја имаме конечната вредност за лицето што треба да се смени. Со следниот код:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">convexhull2</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">convexHull</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">landmarks_points2</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">))</span>
<span class="n">img2_face_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">img2_gray</span><span class="p">)</span>
<span class="n">img2_head_mask</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">fillConvexPoly</span><span class="p">(</span><span class="n">img2_face_mask</span><span class="p">,</span> <span class="n">convexhull2</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>
<span class="n">img2_face_mask</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">bitwise_not</span><span class="p">(</span><span class="n">img2_head_mask</span><span class="p">)</span>
<span class="n">img2_head_noface</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">bitwise_and</span><span class="p">(</span><span class="n">img2</span><span class="p">,</span> <span class="n">img2</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">img2_face_mask</span><span class="p">)</span>
</pre></div>
</div>
<p>Ќе ги земеме надворешните од “landmark” точките на второто лице и со нивна помош ќе креираме маска на второто лице. Со помош на неколку операции ќе го земеме надворешниот дел од дестинациската слика, односно тој кој е надвор од надворешните “landmark” точки:</p>
<p><img alt="dest_image_no_face" src="_images/dest_image_no_face.jpg" /></p>
</li>
<li><p>Со помош на додавање на претходните два резултати го добиваме и крајниот исход:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">result</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">img2_head_noface</span><span class="p">,</span> <span class="n">img2_new_face</span><span class="p">)</span>
</pre></div>
</div>
<p><img alt="end_res1" src="_images/end_res1.jpg" /></p>
</li>
<li><p>Со помош на функција која ја најдовме како идеја за подобрување на крајниот резултат добивме и подобрување на решението:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">boundingRect</span><span class="p">(</span><span class="n">convexhull2</span><span class="p">)</span>
<span class="n">center_face2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">x</span> <span class="o">+</span> <span class="n">x</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span> <span class="nb">int</span><span class="p">((</span><span class="n">y</span> <span class="o">+</span> <span class="n">y</span> <span class="o">+</span> <span class="n">h</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">seamlessclone</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">seamlessClone</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">img2</span><span class="p">,</span> <span class="n">img2_head_mask</span><span class="p">,</span> <span class="n">center_face2</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">MIXED_CLONE</span><span class="p">)</span>
</pre></div>
</div>
<p>Функцијата како аргументи прима:</p>
<ul class="simple">
<li><p>лицето кое треба да се преслика</p></li>
<li><p>дестинациската слика за пресликување</p></li>
<li><p>маската со позицијата каде што треба да е лицето</p></li>
<li><p>координати со правоаголникот кој што ја обиколува позицијата каде што треба да е лицето</p></li>
</ul>
<p>Крајниот резултат од оваа примена е:</p>
<p><img alt="end_res2" src="_images/end_res2.jpg" /></p>
</li>
</ul>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        
        <div class='prev-next-bottom'>
            
    <a class='left-prev' id="prev-link" href="notebooks.html" title="previous page">Програма</a>
    <a class='right-next' id="next-link" href="usage.html" title="next page">Deepfakes</a>

        </div>
        
        </div>
    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          By Teona Kostova, Roberto Kostov<br/>
        
            &copy; Copyright 2021.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
  
  <script src="_static/js/index.1c5a1a01449ed65a7b51.js"></script>

  
  </body>
</html>